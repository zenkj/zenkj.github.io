# linux路由分析

## 传统路由过程

传统路由都会采用路由表(routing table)，所谓路由表，就是一个根据目的地址，静态选择网关和出口网卡的地方。
路由表是一个列表，列表的每一项包含了目标地址或地址段，对应的网关地址，出口网卡，以及一些其他配置
信息。比如：

···shell
jzjian@k8s-05:~$ route -n
Kernel IP routing table
Destination     Gateway         Genmask         Flags Metric Ref    Use Iface
0.0.0.0         192.168.0.1     0.0.0.0         UG    100    0        0 eth0
42.120.18.112   192.168.0.1     255.255.255.255 UGH   0      0        0 eth1
169.254.169.254 192.168.0.1     255.255.255.255 UGH   100    0        0 eth0
192.168.0.0     0.0.0.0         255.255.255.0   U     100    0        0 eth0
192.168.0.0     0.0.0.0         255.255.255.0   U     101    0        0 eth1
···

路由表中有8项数据，最重要的是目的地址（Destination），掩码（Genmask），网关（Gateway）
以及出口网卡（Iface）。Flags中U是Up之意，G是说有网关，H说明这个目标地址是一个单独的
主机IP，而不是一个目标IP网段。

对于Flags中没有H的路由项，代表这是一个网段路由，Genmask必须有值。对于所有其他路由表项
都没有匹配的路由，将使用默认路由。默认路由的目的地址是0.0.0.0，Genmask也是0.0.0.0，就是
上面实例中的第一条路由。

## linux路由过程

传统路由采用路由表进行路由判断，路由表只能根据目的IP地址选择路由，无法根据进口网卡、源IP
地址等信息来路由。linux支持路由表的概念，但是linux支持存在256个路由表，每个路由表有一个
id，管理员可以给这个路由表起一个名字，在/etc/iproute2/rt_tables文件中定义路由表id和名字
的映射关系。在路由表之上，linux创建了路由策略的概念。路由策略也是一张表，表中的每个表项
根据源地址、进口网卡等信息，选择一个动作，绝大多数情况下，这个动作就是选择哪个路由表。
linux中可以有32768个路由策略项，每一项都有一个id，linux会从头到尾执行所有的测试，如果通过
就执行该路由策略项指定的动作，比如选择使用某张路由表进行路由。

linux默认创建三个路由策略项，分别为路由策略项0，路由策略项32766和路由策略项32767，查看如下：

···shell
jzjian@k8s-05:~$ ip rule list
0:	from all lookup local 
32766:	from all lookup main 
32767:	from all lookup default 
···

这三个策略项分别选择local路由表，main路由表和default路由表，查看/etc/iproute2/rt_tables文件，
会发现这三个路由表的id分别是255，254和253。其中local路由表由linux内核自动管理，main路由表是
所有手工添加的路由所在地方，是默认路由表，route命令操作的路由表就是main路由表。default路由表
一般不用。

linux路由过程中，首先执行第一条路由策略，使用local路由表进行路由。local路由表中包含了本地地址、
广播地址和nat的路由项，如果满足，则直接走这一条路由策略，如果不满足，执行先一个路由策略。

默认情况下，下一个路由策略就是32766，该策略让所有的包都走main路由表。在main路由表中，按照传统
路由过程执行判断，通过目标地址来进行判断应该走哪个网关，通过哪个网卡进行传输。

综上所述，linux上的路由过程是这样的：
对于目的地是本地地址或广播地址，使用local路由表进行路由；
对于其他目的地址，使用main路由表，也就是route -n看到的路由表进行路由。
